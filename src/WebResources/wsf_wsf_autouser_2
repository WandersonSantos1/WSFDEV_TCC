function PreencherUsuarioLogado(executionContext) {
    var formContext = executionContext.getFormContext();

    // 1. Só roda se for um formulário de CRIAÇÃO (Novo Pedido)
    if (formContext.ui.getFormType() !== 1) return;

    // 2. Pega o ID do usuário que está logado no Windows/Navegador
    var userSettings = Xrm.Utility.getGlobalContext().userSettings;
    var userId = userSettings.userId.replace("{", "").replace("}", "");

    // 3. Pergunta ao sistema: "Qual é o email interno desse usuário?"
    Xrm.WebApi.retrieveRecord("systemuser", userId, "?$select=internalemailaddress").then(
        function success(result) {
            var emailUsuario = result.internalemailaddress;
            
            if (emailUsuario != null) {
                // Se achou o email, chama a função para buscar o contato correspondente
                BuscarContatoPeloEmail(formContext, emailUsuario);
            }
        },
        function (error) {
            console.log("Erro ao buscar dados do usuário logado: " + error.message);
        }
    );
}

function BuscarContatoPeloEmail(formContext, email) {
    // 4. Pesquisa na tabela de CONTATOS alguém com esse mesmo email
    var filtro = "?$select=contactid,fullname&$filter=emailaddress1 eq '" + email + "'";

    Xrm.WebApi.retrieveMultipleRecords("contact", filtro).then(
        function success(result) {
            if (result.entities.length > 0) {
                // ACHOU! Pega o primeiro contato que encontrou
                var contato = result.entities[0];

                // Monta o valor para o campo Lookup
                var valorLookup = [{
                    id: contato.contactid,
                    name: contato.fullname,
                    entityType: "contact"
                }];

                // 5. Preenche o campo na tela
                // CONFIRA SE O NOME DO SEU CAMPO É 'wsf_solicitante'
                var campoSolicitante = formContext.getAttribute("wsf_solicitante"); 
                var controleSolicitante = formContext.getControl("wsf_solicitante"); 

                if (campoSolicitante != null) {
                    campoSolicitante.setValue(valorLookup); // Preenche
                    
                    if (controleSolicitante != null) {
                        controleSolicitante.setDisabled(true); // Trava para não mudar
                    }
                }
            }
        },
        function (error) {
            console.log("Erro ao buscar contato pelo email: " + error.message);
        }
    );
}